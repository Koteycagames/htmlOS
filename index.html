<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HTML OS</title>
    <link rel="icon" href="data:,">
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;600&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body, html { height: 100%; overflow: hidden; background: #000; color: #fff; }
        .screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: none; flex-direction: column; justify-content: center; align-items: center; }
        .screen.active { display: flex; }
        #login input, #register input { width: 280px; padding: 12px; margin: 8px 0; background: #222; border: 1px solid #0f0; color: #0f0; border-radius: 6px; font-size: 16px; }
        #login button, #register button { width: 280px; padding: 12px; margin: 8px 0; background: #0f0; color: #000; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; }
        #login button:hover, #register button:hover { background: #0c0; }
        #main { gap: 20px; }
        #main div { font-size: 24px; }
        #main button { padding: 16px 40px; font-size: 20px; background: #0f0; color: #000; border: none; border-radius: 8px; cursor: pointer; }
        #main button:hover { background: #0c0; }
        #systemButtons { position: absolute; top: 10px; left: 10px; display: flex; flex-direction: column; gap: 10px; }
        #systemButtons button { padding: 10px 20px; font-size: 16px; background: #0f0; color: #000; border: none; border-radius: 6px; cursor: pointer; }
        #systemButtons button:hover { background: #0c0; }
        #store { gap: 10px; }
        #store div { font-size: 18px; cursor: pointer; }
        #store button { padding: 12px; background: #0f0; color: #000; border: none; border-radius: 6px; cursor: pointer; }
        #store button:hover { background: #0c0; }
        #blackscreen button { padding: 16px 32px; font-size: 18px; background: #0f0; color: #000; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; margin: 10px; }
        #blackscreen button:hover { background: #0c0; }
        #nosignal { background: #111; font-size: 48px; font-weight: 600; letter-spacing: 8px; color: #333; text-shadow: 0 0 10px #0f0; animation: glitch 1s infinite; position: relative; }
        @keyframes glitch { 0%, 100% { text-shadow: 0 0 10px #0f0; } 50% { text-shadow: 2px 2px 10px #f00, -2px -2px 10px #0ff; } }
        #logo { width: 180px; height: 180px; background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect x="10" y="10" width="80" height="80" fill="%230f0"/><text x="50" y="60" font-family="Arial" font-size="40" fill="%23000" text-anchor="middle">OS</text></svg>') center/contain no-repeat; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
        #avatar { width: 120px; height: 120px; border-radius: 50%; background: #0f0; margin-bottom: 20px; display: flex; justify-content: center; align-items: center; font-size: 48px; color: #000; font-weight: bold; }
        #userName { font-size: 28px; margin-bottom: 30px; }
        #loginBtn { padding: 12px 40px; background: #0f0; color: #000; border: none; border-radius: 8px; font-size: 18px; cursor: pointer; }
        #loginBtn:hover { background: #0c0; }
        #desktop { background: url('https://images.unsplash.com/photo-1518709268805-4e9042af9f23?auto=format&fit=crop&w=1600&q=80') center/cover; position: relative; }
        #desktop-icons { position: absolute; top: 0; left: 0; width: 100%; height: calc(100% - 48px); display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); padding: 20px; overflow: auto; }
        .desktop-item { text-align: center; cursor: pointer; padding: 8px; border-radius: 6px; transition: 0.2s; }
        .desktop-item:hover { background: rgba(0,255,0,0.1); }
        .desktop-item.selected { background: #0f0; color: #000; }
        .desktop-icon { width: 48px; height: 48px; margin: 0 auto 8px; background: #0f0; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 24px; color: #000; }
        .desktop-name { font-size: 12px; word-break: break-all; }
        #taskbar { position: fixed; bottom: 0; left: 0; width: 100%; height: 48px; background: rgba(0,0,0,0.7); backdrop-filter: blur(12px); display: flex; align-items: center; padding: 0 8px; z-index: 100; }
        #startBtn { width: 40px; height: 40px; background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23fff"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>') center/24px no-repeat; border-radius: 8px; cursor: pointer; }
        #startBtn:hover { background-color: rgba(255,255,255,0.1); }
        #startMenu { position: fixed; bottom: 56px; left: 8px; width: 360px; height: 480px; background: rgba(30,30,30,0.95); backdrop-filter: blur(20px); border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.4); transform: scale(0.9); opacity: 0; transform-origin: bottom left; transition: 0.2s ease; pointer-events: none; }
        #startMenu.open { transform: scale(1); opacity: 1; pointer-events: auto; }
        #timeLeft { font-size: 14px; color: #0f0; margin-left: 10px; }
        #wifiTime { font-size: 14px; color: #0f0; margin-left: 10px; }
        .tile { width: 100px; height: 100px; background: rgba(255,255,255,0.1); border-radius: 8px; display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; margin: 8px; transition: 0.2s; }
        .tile:hover { background: #0f0; color: #000; transform: translateY(-4px); }
        .app-window { position: fixed; background: #1e1e1e; border-radius: 12px; box-shadow: 0 16px 32px rgba(0,0,0,0.5); display: none; flex-direction: column; z-index: 200; resize: both; overflow: hidden; min-width: 300px; min-height: 200px; }
        .app-window.open { display: flex; }
        .app-window.maximized { top: 0 !important; left: 0 !important; width: 100% !important; height: 100% !important; border-radius: 0; resize: none; }
        .win-title { padding: 12px 16px; background: #2d2d2d; border-bottom: 1px solid #444; font-weight: 600; display: flex; justify-content: space-between; align-items: center; cursor: move; user-select: none; }
        .win-controls button { width: 24px; height: 24px; margin-left: 4px; background: #444; color: #fff; border: none; border-radius: 4px; font-size: 14px; cursor: pointer; }
        .win-controls button:hover { background: #666; }
        #explorerPath { padding: 8px; background: #000; color: #0f0; font-family: monospace; font-size: 14px; }
        #explorerContent { flex: 1; padding: 16px; overflow-y: auto; display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 16px; }
        .file-item { text-align: center; cursor: pointer; padding: 8px; border-radius: 6px; transition: 0.2s; }
        .file-item:hover { background: rgba(0,255,0,0.1); }
        .file-item.selected { background: #0f0; color: #000; }
        .file-icon { width: 48px; height: 48px; margin: 0 auto 8px; background: #0f0; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 24px; color: #000; }
        .file-name { font-size: 12px; word-break: break-all; }
        #explorerActions { padding: 8px; background: #2d2d2d; display: flex; gap: 8px; justify-content: center; border-top: 1px solid #444; }
        #explorerActions button { padding: 6px 12px; background: #444; color: #fff; border: none; border-radius: 4px; cursor: pointer; }
        #taskbar-apps { display: flex; gap: 4px; margin-left: 8px; flex: 1; justify-content: flex-start; overflow-x: auto; max-width: calc(100% - 200px); }
        .taskbar-app { min-width: 120px; padding: 0 12px; height: 32px; background: rgba(255,255,255,0.1); color: #fff; border-radius: 6px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 13px; white-space: nowrap; }
        .taskbar-app:hover { background: rgba(255,255,255,0.2); }
        #shutdownLogo { width: 120px; height: 120px; background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect x="10" y="10" width="80" height="80" fill="%230f0"/><text x="50" y="60" font-family="Arial" font-size="40" fill="%23000" text-anchor="middle">OS</text></svg>') center/contain no-repeat; margin-bottom: 30px; animation: pulse 1.5s infinite; }
        #shutdownText { font-size: 28px; margin-bottom: 10px; }
        #shutdownDots { font-size: 24px; letter-spacing: 8px; }
        #shutdownDots span { animation: dot 1.5s infinite; }
        #shutdownDots span:nth-child(1) { animation-delay: 0s; }
        #shutdownDots span:nth-child(2) { animation-delay: 0.3s; }
        #shutdownDots span:nth-child(3) { animation-delay: 0.6s; }
        @keyframes dot { 0%, 100% { opacity: 0.3; } 50% { opacity: 1; } }
        #notepadText { flex: 1; padding: 16px; background: #000; color: #0f0; font-family: monospace; border: none; outline: none; resize: none; font-size: 14px; line-height: 1.5; white-space: pre-wrap; overflow: auto; }
        #calcDisplay { padding: 20px; font-size: 36px; text-align: right; background: #000; color: #0f0; border-bottom: 1px solid #444; }
        .calc-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1px; background: #333; flex: 1; }
        .calc-btn { padding: 20px; background: #424242; color: #fff; text-align: center; cursor: pointer; font-size: 18px; }
        .calc-btn:hover { background: #555; }
        .calc-btn.operator { background: #0a0; }
        .calc-btn.operator:hover { background: #0c0; }
        #wifiMenu { position: fixed; bottom: 56px; right: 8px; width: 300px; background: rgba(30,30,30,0.95); backdrop-filter: blur(20px); border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.4); transform: scale(0.9); opacity: 0; transform-origin: bottom right; transition: 0.2s ease; pointer-events: none; padding: 16px; }
        #wifiMenu.open { transform: scale(1); opacity: 1; pointer-events: auto; }
        .wifi-item { padding: 8px; background: rgba(255,255,255,0.1); border-radius: 6px; margin-bottom: 8px; cursor: pointer; }
        .wifi-item:hover { background: rgba(255,255,255,0.2); }
        .wifi-item.connected { background: #0f0; color: #000; }
        #browserNav { display: flex; align-items: center; background: #000; }
        #browserAddress { flex: 1; padding: 8px; color: #0f0; font-family: monospace; font-size: 14px; border: none; }
        #browserHomeBtn { padding: 8px; background: #444; color: #fff; border: none; cursor: pointer; }
        #browserHomeBtn:hover { background: #666; }
        #browserContent { flex: 1; padding: 16px; background: #fff; color: #000; overflow: auto; }
        #browserDownloads { position: absolute; top: 0; right: 0; width: 200px; background: rgba(255,255,255,0.8); color: #000; border-bottom-left-radius: 8px; padding: 8px; z-index: 10; display: none; }
        .download-item { margin-bottom: 8px; }
        .download-progress { height: 4px; background: #ddd; }
        .download-progress-bar { height: 100%; background: #0f0; width: 0%; }
        #bsod-screen { background: #0000aa; color: #fff; font-family: monospace; padding: 40px; display: none; flex-direction: column; }
        #bsod-screen p { margin: 10px 0; }
        #nosignal-input { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); width: 400px; padding: 10px; background: #000; color: #0f0; border: 1px solid #0f0; font-family: monospace; display: none; }
        @keyframes flicker { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
        .flicker { animation: flicker 0.1s infinite; }
        #contextMenu { position: fixed; background: rgba(30,30,30,0.95); backdrop-filter: blur(20px); border-radius: 8px; box-shadow: 0 4px 16px rgba(0,0,0,0.4); padding: 8px 0; z-index: 300; display: none; }
        .context-item { padding: 8px 16px; cursor: pointer; }
        .context-item:hover { background: #0f0; color: #000; }
        #messengerContent { flex: 1; display: flex; flex-direction: column; }
        #chatList { flex: 1; overflow-y: auto; padding: 16px; background: #000; color: #0f0; }
        #chatInput { padding: 8px; background: #222; color: #0f0; border: none; }
        #messengerAuth { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        #messengerAuth input { width: 280px; padding: 12px; margin: 8px 0; background: #222; border: 1px solid #0f0; color: #0f0; border-radius: 6px; font-size: 16px; }
        #messengerAuth button { width: 280px; padding: 12px; margin: 8px 0; background: #0f0; color: #000; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; }
    </style>
</head>
<body>
<!-- LOGIN -->
<div id="login" class="screen active">
    <h2>Вход</h2>
    <input type="email" id="loginEmail" placeholder="Email">
    <input type="password" id="loginPassword" placeholder="Пароль">
    <button onclick="login()">Войти</button>
    <button onclick="goTo('register')">Регистрация</button>
</div>
<!-- REGISTER -->
<div id="register" class="screen">
    <h2>Регистрация</h2>
    <input type="email" id="regEmail" placeholder="Email">
    <input type="password" id="regPassword" placeholder="Пароль">
    <button onclick="register()">Зарегистрироваться</button>
    <button onclick="goTo('login')">Назад</button>
</div>
<!-- MAIN MENU -->
<div id="main" class="screen">
    <div id="systemButtons">
        <button onclick="restoreSystem()">Восстановить систему (300 монет)</button>
        <button onclick="removeViruses()">Удалить вирусы (400 монет)</button>
    </div>
    <div>Монеты: <span id="coins">0</span></div>
    <div>ОС: <span id="time_os">0</span> мин | Wi-Fi: <span id="wifi_time">0</span> мин</div>
    <button onclick="enterOS()">Зайти в ОС</button>
    <button onclick="goTo('store')">Купить</button>
</div>
<!-- STORE -->
<div id="store" class="screen">
    <h2>Магазин</h2>
    <div>1 минута ОС - 10 монет</div>
    <div>1 минута Бомж Wi-Fi - 20 монет</div>
    <div>1 минута Средний Wi-Fi - 30 монет</div>
    <div>1 минута Ultra fast - 50 монет</div>
    <h3>Корзина:</h3>
    <div id="cart"></div>
    <button onclick="addToCart('os')">+1 мин ОС</button>
    <button onclick="addToCart('bomj')">+1 мин Бомж</button>
    <button onclick="addToCart('medium')">+1 мин Средний</button>
    <button onclick="addToCart('ultra')">+1 мин Ultra</button>
    <button onclick="checkout()">Оплатить</button>
    <button onclick="goTo('main')">Назад</button>
</div>
<!-- ОС -->
<div id="blackscreen" class="screen">
    <button onclick="launchOS()">Запустить</button>
    <button onclick="goTo('main')">Вернуться в меню</button>
</div>
<div id="delay1" class="screen"></div>
<div id="nosignal" class="screen">
    NO SIGNAL
    <input id="nosignal-input" type="text" placeholder="scan / repair" onkeydown="if(event.key==='Enter') runNoSignalCmd();">
</div>
<div id="start" class="screen"><div id="logo"></div></div>
<div id="user" class="screen">
    <div id="avatar">U</div>
    <div id="userName">Гость</div>
    <button id="loginBtn" onclick="goTo('desktop')">Войти</button>
</div>
<!-- BSOD -->
<div id="bsod-screen" class="screen">
    <p>*** STOP: 0x0000007B (INACCESSIBLE_BOOT_DEVICE)</p>
    <p>Система не может загрузиться.</p>
    <button onclick="location.reload()">Перезагрузить</button>
</div>
<!-- ДЕСКТОП -->
<div id="desktop" class="screen">
    <div id="desktop-icons"></div>
    <div id="taskbar">
        <div id="startBtn" onclick="toggleStartMenu()"></div>
        <div id="timeLeft">Времени осталось: 0 мин</div>
        <div id="wifiTime">Wi-Fi: 0 мин</div>
        <div id="taskbar-apps"></div>
        <div style="flex:1"></div>
        <div id="wifiBtn" onclick="toggleWifiMenu()" style="width:40px;height:40px;background:url('data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%2024%2024%22%20fill%3D%22%23fff%22%3E%3Cpath%20d%3D%22M12%2021l-1-2a7%207%200%200114%200l-1%202a5%205%200%2000-12%200zm-3-4a10%2010%200%200121%200l-1%202a8%208%200%2000-19%200l-1-2zm-3-4a13%2013%200%200127%200l-1%202a11%2011%200%2000-25%200l-1-2z%22%2F%3E%3C%2Fsvg%3E') center/24px no-repeat;border-radius:8px;cursor:pointer;margin-right:8px;"></div>
        <div style="color:#aaa;font-size:12px;" id="clock">12:00</div>
    </div>
    <div id="startMenu">
        <div style="padding:16px;display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;">
            <div class="tile" onclick="openApp('explorer')">Проводник</div>
            <div class="tile" onclick="openApp('calc')">Калькулятор</div>
            <div class="tile" onclick="openApp('notepad')">Блокнот</div>
            <div class="tile" onclick="openApp('browser')">Браузер</div>
            <div class="tile" onclick="openApp('messenger')">Мессенджер</div>
            <div class="tile" onclick="goTo('shutdown')">Выключить</div>
        </div>
    </div>
    <!-- ПРОВОДНИК -->
    <div id="explorer" class="app-window" style="top:10%;left:10%;width:700px;height:500px;">
        <div class="win-title" onmousedown="dragStart(event,'explorer')">
            <span>Проводник</span>
            <div class="win-controls">
                <button onclick="minimizeApp('explorer')">–</button>
                <button onclick="toggleMaximize('explorer')">□</button>
                <button onclick="closeApp('explorer')">×</button>
            </div>
        </div>
        <div id="explorerPath">Компьютер</div>
        <div id="explorerContent"></div>
        <div id="explorerActions" style="display:none;">
            <button onclick="createNewFolder()">Новая папка</button>
            <button onclick="createNewTextFile()">Новый текст. файл</button>
            <button onclick="deleteSelected()">Удалить</button>
            <button onclick="renameSelected()">Переименовать</button>
        </div>
    </div>
    <!-- КАЛЬКУЛЯТОР -->
    <div id="calc" class="app-window" style="top:15%;left:15%;width:320px;height:420px;">
        <div class="win-title" onmousedown="dragStart(event,'calc')">
            <span>Калькулятор</span>
            <div class="win-controls">
                <button onclick="minimizeApp('calc')">–</button>
                <button onclick="toggleMaximize('calc')">□</button>
                <button onclick="closeApp('calc')">×</button>
            </div>
        </div>
        <div id="calcDisplay">0</div>
        <div class="calc-grid">
            <div class="calc-btn" onclick="calc('C')">C</div>
            <div class="calc-btn" onclick="calc('±')">±</div>
            <div class="calc-btn" onclick="calc('%')">%</div>
            <div class="calc-btn operator" onclick="calc('/')">/</div>
            <div class="calc-btn" onclick="calc('7')">7</div>
            <div class="calc-btn" onclick="calc('8')">8</div>
            <div class="calc-btn" onclick="calc('9')">9</div>
            <div class="calc-btn operator" onclick="calc('*')">×</div>
            <div class="calc-btn" onclick="calc('4')">4</div>
            <div class="calc-btn" onclick="calc('5')">5</div>
            <div class="calc-btn" onclick="calc('6')">6</div>
            <div class="calc-btn operator" onclick="calc('-')">-</div>
            <div class="calc-btn" onclick="calc('1')">1</div>
            <div class="calc-btn" onclick="calc('2')">2</div>
            <div class="calc-btn" onclick="calc('3')">3</div>
            <div class="calc-btn operator" onclick="calc('+')">+</div>
            <div class="calc-btn" style="grid-column:span 2;" onclick="calc('0')">0</div>
            <div class="calc-btn" onclick="calc('.')">.</div>
            <div class="calc-btn operator" onclick="calc('=')">=</div>
        </div>
    </div>
    <!-- БЛОКНОТ -->
    <div id="notepad" class="app-window" style="top:18%;left:20%;width:500px;height:380px;">
        <div class="win-title" onmousedown="dragStart(event,'notepad')">
            <span>Блокнот</span>
            <div class="win-controls">
                <button onclick="minimizeApp('notepad')">–</button>
                <button onclick="toggleMaximize('notepad')">□</button>
                <button onclick="closeApp('notepad')">×</button>
            </div>
        </div>
        <textarea id="notepadText" placeholder="Начните печатать..." oninput="updateFileSize()"></textarea>
    </div>
    <!-- БРАУЗЕР -->
    <div id="browser" class="app-window" style="top:12%;left:12%;width:800px;height:600px;">
        <div class="win-title" onmousedown="dragStart(event,'browser')">
            <span>Браузер</span>
            <div class="win-controls">
                <button onclick="minimizeApp('browser')">–</button>
                <button onclick="toggleMaximize('browser')">□</button>
                <button onclick="closeApp('browser')">×</button>
            </div>
        </div>
        <div id="browserNav">
            <input id="browserAddress" type="text" placeholder="Введите URL..." onkeydown="if(event.key==='Enter') loadPage();">
            <button id="browserHomeBtn" onclick="goHome()">Домой</button>
        </div>
        <div id="browserDownloads"></div>
        <div id="browserContent"></div>
    </div>
    <!-- МЕССЕНДЖЕР -->
    <div id="messenger" class="app-window" style="top:20%;left:25%;width:600px;height:500px;">
        <div class="win-title" onmousedown="dragStart(event,'messenger')">
            <span>Мессенджер</span>
            <div class="win-controls">
                <button onclick="minimizeApp('messenger')">–</button>
                <button onclick="toggleMaximize('messenger')">□</button>
                <button onclick="closeApp('messenger')">×</button>
            </div>
        </div>
        <div id="messengerContent">
            <div id="messengerAuth">
                <h2>Вход / Регистрация</h2>
                <input id="msgUsername" placeholder="ID (username)">
                <input id="msgPassword" type="password" placeholder="Пароль">
                <button onclick="msgLogin()">Войти</button>
                <button onclick="msgRegister()">Зарегистрироваться</button>
            </div>
            <div id="chatInterface" style="display:none; flex-direction:column; flex:1;">
                <input id="chatTarget" placeholder="ID собеседника">
                <div id="chatList"></div>
                <input id="chatInput" placeholder="Сообщение" onkeydown="if(event.key==='Enter') sendMessage();">
            </div>
        </div>
    </div>
</div>
<!-- ВЫКЛЮЧЕНИЕ -->
<div id="shutdown" class="screen">
    <div id="shutdownLogo"></div>
    <div id="shutdownText">Завершение работы</div>
    <div id="shutdownDots"><span>.</span><span>.</span><span>.</span></div>
</div>
<!-- Wi-Fi -->
<div id="wifiMenu">
    <div class="wifi-item" onclick="connectWifi('bomj')">Бомж Wi-Fi</div>
    <div class="wifi-item" onclick="connectWifi('medium')">Средний Wi-Fi</div>
    <div class="wifi-item" onclick="connectWifi('ultra')">Ultra fast</div>
</div>
<!-- КОНТЕКСТНОЕ МЕНЮ -->
<div id="contextMenu">
    <div class="context-item" onclick="createNewFolder()">Новая папка</div>
    <div class="context-item" onclick="createNewTextFile()">Новый текстовый файл</div>
    <div class="context-item" onclick="showProperties()">Свойства</div>
    <div class="context-item" onclick="deleteSelected()">Удалить</div>
    <div class="context-item" onclick="renameSelected()">Переименовать</div>
</div>
<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
/* ==================== FIREBASE ==================== */
const firebaseConfig = {
  apiKey: "AIzaSyB2wR10RWpKOaGPpcoYFvfh1hnyHnM-zRY",
  authDomain: "htmlos-5335c.firebaseapp.com",
  databaseURL: "https://htmlos-5335c-default-rtdb.firebaseio.com",
  projectId: "htmlos-5335c",
  storageBucket: "htmlos-5335c.firebasestorage.app",
  messagingSenderId: "601743333046",
  appId: "1:601743333046:web:ca33341b9c7cf4cdb1f817"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();
let currentUser = null;
let timeInterval = null, wifiInterval = null;
let cart = {os:0,bomj:0,medium:0,ultra:0};
let previousScreen = '';
let connected = false, currentNetwork = '';
let currentUserName = "Гость";
let currentPath = [], selectedFile = null;
const stateKey = 'html_os_state';
let systemState = JSON.parse(localStorage.getItem(stateKey)) || {deleted:[]};
let fs = {
    'C:':{
        'HTML OS':{type:'folder',system:true,
            'Fonts':{type:'folder','Arial.ttf':{type:'file',size:0}},
            'System':{type:'folder','Kernel.dll':{type:'file',size:0}},
            'Boot':{type:'folder','Bootloader.exe':{type:'file',size:0}},
            'Programs':{type:'folder','Calc.exe':{type:'file',size:0}},
            'Drivers':{type:'folder','Graphics.drv':{type:'file',size:0}},
            'Config':{type:'folder','Settings.ini':{type:'file',size:0}},
            'Temp':{type:'folder'},
            'Logs':{type:'folder','System.log':{type:'file',size:0}},
            'Resources':{type:'folder','Icons':{type:'folder'}},
            'Security':{type:'folder','Firewall.rules':{type:'file',size:0}}
        },
        'Users':{type:'folder',system:true}
    }
};
const virusFiles = ['gift.exe', 'hack.exe', 'crack.exe', 'money.exe', 'scan.exe', 'update.exe', 'premium.exe', 'cheat.exe', 'torrent.exe', 'vpn.exe'];
let msgUser = null;
let currentChatTarget = null;
let contextTarget = 'explorer';
/* ==================== ФУНКЦИИ ДОЛЖНЫ БЫТЬ ВЫШЕ ==================== */
function goTo(id) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    const el = document.getElementById(id);
    if (el) el.classList.add('active');
    if (id === 'delay1') setTimeout(() => goTo('nosignal'), 2000);
    if (id === 'nosignal') {
        if (previousScreen === 'delay1') setTimeout(() => goTo('start'), 3000);
    }
    if (id === 'start') {
        if(!checkSystemIntegrity()) return;
        setTimeout(() => goTo('user'), 3000);
    }
    if (id === 'desktop') { checkSystemIntegrity(); updateTaskbar(); startOSTimer(); autoConnectWifi(); renderDesktop(); }
    if (id === 'shutdown') setTimeout(() => { saveUserFiles(); localStorage.setItem(stateKey, JSON.stringify(systemState)); goTo('main'); }, 5000);
}
function loadUserData(uid) {
    db.ref('users/' + uid + '/coins').on('value', s => document.getElementById('coins').textContent = s.val()||0);
    db.ref('users/' + uid + '/time_os').on('value', s => {
        document.getElementById('time_os').textContent = s.val()||0;
        document.getElementById('timeLeft').textContent = `Времени осталось: ${s.val()||0} мин`;
    });
    const updateWifiTime = () => {
        Promise.all([
            db.ref('users/' + uid + '/time_bomj').once('value').then(s => s.val()||0),
            db.ref('users/' + uid + '/time_medium').once('value').then(s => s.val()||0),
            db.ref('users/' + uid + '/time_ultra').once('value').then(s => s.val()||0)
        ]).then(([b,m,u]) => {
            const total = b + m + u;
            document.getElementById('wifi_time').textContent = total;
            document.getElementById('wifiTime').textContent = `Wi-Fi: ${total} мин`;
        });
    };
    updateWifiTime();
    db.ref('users/' + uid).on('child_changed', updateWifiTime);
}
function login() {
    const e = document.getElementById('loginEmail').value;
    const p = document.getElementById('loginPassword').value;
    auth.signInWithEmailAndPassword(e, p).catch(err => alert(err.message));
}
function register() {
    const e = document.getElementById('regEmail').value;
    const p = document.getElementById('regPassword').value;
    auth.createUserWithEmailAndPassword(e, p)
        .then(cred => db.ref('users/' + cred.user.uid).set({coins:0,time_os:0,time_bomj:0,time_medium:0,time_ultra:0}))
        .catch(err => alert(err.message));
}
/* ==================== АВТОРИЗАЦИЯ ==================== */
auth.onAuthStateChanged(u => {
    if (u) {
        currentUser = u;
        currentUserName = u.email.split('@')[0];
        document.getElementById('userName').textContent = currentUserName;
        loadUserData(u.uid);
        loadUserFiles();
        goTo('main');
    } else {
        currentUser = null;
        goTo('login');
    }
});
function loadUserFiles() {
    const saved = localStorage.getItem('user_files_' + currentUserName);
    if (saved) {
        const userData = JSON.parse(saved);
        if (!fs['C:']['Users'][currentUserName]) fs['C:']['Users'][currentUserName] = {type:'folder'};
        Object.assign(fs['C:']['Users'][currentUserName], userData);
    }
}
function saveUserFiles() {
    if (currentUserName && fs['C:']['Users'][currentUserName]) {
        localStorage.setItem('user_files_' + currentUserName, JSON.stringify(fs['C:']['Users'][currentUserName]));
    }
    if (document.getElementById('desktop').classList.contains('active')) renderDesktop();
    if (document.getElementById('explorer').classList.contains('open')) renderExplorer();
}
/* NO SIGNAL CMD */
document.addEventListener('keydown', (e) => {
    if (document.getElementById('nosignal').classList.contains('active') && e.code === 'Space') {
        e.preventDefault();
        const input = document.getElementById('nosignal-input');
        input.style.display = 'block';
        input.focus();
    }
});
function runNoSignalCmd() {
    const input = document.getElementById('nosignal-input');
    const cmd = input.value.trim().toLowerCase();
    input.value = '';
    input.style.display = 'none';
    if (cmd === 'scan') {
        const damaged = systemState.deleted.includes('Boot');
        alert(damaged ? 'Система повреждена (Boot удалён)' : 'Система в порядке');
    } else if (cmd === 'repair') {
        systemState.deleted = systemState.deleted.filter(f => f !== 'Boot');
        localStorage.setItem(stateKey, JSON.stringify(systemState));
        alert('Система восстановлена! Перезапустите ОС.');
    } else {
        alert('Неизвестная команда');
    }
}
/* ВОССТАНОВЛЕНИЕ И УДАЛЕНИЕ ВИРУСОВ */
function restoreSystem() {
    db.ref('users/' + currentUser.uid + '/coins').transaction(c => {
        if ((c || 0) >= 300) {
            systemState.deleted = [];
            localStorage.setItem(stateKey, JSON.stringify(systemState));
            alert('Система восстановлена!');
            return (c || 0) - 300;
        } else {
            alert('Недостаточно монет');
            return c;
        }
    });
}
function removeViruses() {
    db.ref('users/' + currentUser.uid + '/coins').transaction(c => {
        if ((c || 0) >= 400) {
            const userFolder = fs['C:']['Users'][currentUserName];
            function removeFromFolder(folder) {
                for (let key in folder) {
                    if (folder[key].type === 'folder') {
                        removeFromFolder(folder[key]);
                    } else if (virusFiles.includes(key)) {
                        delete folder[key];
                    }
                }
            }
            removeFromFolder(userFolder);
            saveUserFiles();
            alert('Вирусы удалены!');
            return (c || 0) - 400;
        } else {
            alert('Недостаточно монет');
            return c;
        }
    });
}
/* МЕССЕНДЖЕР */
function msgRegister() {
    const username = document.getElementById('msgUsername').value;
    const password = document.getElementById('msgPassword').value;
    if (!username || !password) return alert('Заполните поля');
    db.ref('messenger_users/' + username).once('value').then(snap => {
        if (snap.exists()) return alert('ID занято');
        db.ref('messenger_users/' + username).set({password: password});
        msgLogin();
    });
}
function msgLogin() {
    const username = document.getElementById('msgUsername').value;
    const password = document.getElementById('msgPassword').value;
    db.ref('messenger_users/' + username).once('value').then(snap => {
        if (snap.exists() && snap.val().password === password) {
            msgUser = username;
            document.getElementById('messengerAuth').style.display = 'none';
            document.getElementById('chatInterface').style.display = 'flex';
        } else {
            alert('Неверные данные');
        }
    });
}
function sendMessage() {
    const target = document.getElementById('chatTarget').value;
    const msg = document.getElementById('chatInput').value;
    if (!target || !msg) return;
    const chatId = [msgUser, target].sort().join('_');
    db.ref('chats/' + chatId).push({from: msgUser, text: msg, time: Date.now()});
    document.getElementById('chatInput').value = '';
    currentChatTarget = target;
}
function listenForMessages() {
    if (!currentChatTarget) return;
    const chatId = [msgUser, currentChatTarget].sort().join('_');
    db.ref('chats/' + chatId).on('value', snap => {
        const list = document.getElementById('chatList');
        list.innerHTML = '';
        snap.forEach(child => {
            const m = child.val();
            list.innerHTML += `<p>${m.from}: ${m.text}</p>`;
        });
        list.scrollTop = list.scrollHeight;
    });
}
/* БРАУЗЕР */
function goHome(){
    document.getElementById('browserAddress').value = '';
    const cont = document.getElementById('browserContent');
    cont.innerHTML = `
        <h2>Популярные сайты:</h2>
        <p><span style="color:#00f;cursor:pointer;" onclick="loadPage('http://news.html')">news.html</span> — Новости</p>
        <p><span style="color:#00f;cursor:pointer;" onclick="loadPage('http://weather.html')">weather.html</span> — Погода</p>
        <p><span style="color:#00f;cursor:pointer;" onclick="loadPage('http://forum.html')">forum.html</span> — Форум</p>
        <p><span style="color:#00f;cursor:pointer;" onclick="loadPage('http://wiki.html')">wiki.html</span> — Энциклопедия</p>
        <p><span style="color:#00f;cursor:pointer;" onclick="loadPage('http://blog.html')">blog.html</span> — Блог</p>
        <p><span style="color:#00f;cursor:pointer;" onclick="loadPage('http://recipe.html')">recipe.html</span> — Рецепты</p>
        <p><span style="color:#00f;cursor:pointer;" onclick="loadPage('http://joke.html')">joke.html</span> — Анекдоты</p>
        <p><span style="color:#00f;cursor:pointer;" onclick="loadPage('http://quote.html')">quote.html</span> — Цитаты</p>
        <p><span style="color:#00f;cursor:pointer;" onclick="loadPage('http://fact.html')">fact.html</span> — Факты</p>
        <p><span style="color:#00f;cursor:pointer;" onclick="loadPage('http://puzzle.html')">puzzle.html</span> — Загадки</p>
        <p><span style="color:#00f;cursor:pointer;" onclick="loadPage('http://notepad.html')">notepad.html</span> — Скачать текстовый редактор</p>
        <p><span style="color:#00f;cursor:pointer;" onclick="loadPage('http://calculator.html')">calculator.html</span> — Скачать продвинутый калькулятор</p>
        <p><span style="color:#00f;cursor:pointer;" onclick="loadPage('http://imageeditor.html')">imageeditor.html</span> — Скачать редактор изображений</p>
        <p><span style="color:#00f;cursor:pointer;" onclick="loadPage('http://musicplayer.html')">musicplayer.html</span> — Скачать плеер музыки</p>
        <p><span style="color:#00f;cursor:pointer;" onclick="loadPage('http://video.html')">video.html</span> — Скачать видео</p>
        <p><span style="color:#00f;cursor:pointer;" onclick="loadPage('http://game1.html')">game1.html</span> — Скачать игру</p>
        <p><span style="color:#00f;cursor:pointer;" onclick="loadPage('http://book.html')">book.html</span> — Скачать книгу</p>
        <p><span style="color:#00f;cursor:pointer;" onclick="loadPage('http://antivirus.html')">antivirus.html</span> — Скачать антивирус</p>
        <p><span style="color:#00f;cursor:pointer;" onclick="loadPage('http://browser.html')">browser.html</span> — Скачать браузер</p>
        <p><span style="color:#00f;cursor:pointer;" onclick="loadPage('http://chat.html')">chat.html</span> — Скачать мессенджер</p>
        <p><span style="color:#00f;cursor:pointer;" onclick="loadPage('http://freegift.html')">freegift.html</span> — Бесплатный подарок</p>
        <p><span style="color:#00f;cursor:pointer;" onclick="loadPage('http://hacktool.html')">hacktool.html</span> — Инструмент для хака</p>
        <p><span style="color:#00f;cursor:pointer;" onclick="loadPage('http://crack.html')">crack.html</span> — Крак для софта</p>
        <p><span style="color:#00f;cursor:pointer;" onclick="loadPage('http://freemoney.html')">freemoney.html</span> — Бесплатные деньги</p>
        <p><span style="color:#00f;cursor:pointer;" onclick="loadPage('http://virusscan.html')">virusscan.html</span> — Сканер вирусов</p>
        <p><span style="color:#00f;cursor:pointer;" onclick="loadPage('http://update.html')">update.html</span> — Обновление системы</p>
        <p><span style="color:#00f;cursor:pointer;" onclick="loadPage('http://premium.html')">premium.html</span> — Премиум бесплатно</p>
        <p><span style="color:#00f;cursor:pointer;" onclick="loadPage('http://cheat.html')">cheat.html</span> — Чит для игр</p>
        <p><span style="color:#00f;cursor:pointer;" onclick="loadPage('http://torrent.html')">torrent.html</span> — Торрент клиент</p>
        <p><span style="color:#00f;cursor:pointer;" onclick="loadPage('http://vpn.html')">vpn.html</span> — VPN сервис</p>
    `;
}
function loadPage(url = document.getElementById('browserAddress').value.trim()){
    const cont = document.getElementById('browserContent');
    if(!connected){ cont.innerHTML = '<p style="color:#f00;text-align:center;">Нет интернета</p>'; return; }
    if(url === '' || url === 'home') { goHome(); return; }
    let page = '', file = '', size = 0;
    switch(url){
        case 'http://news.html': page = 'Новости'; cont.innerHTML = `<h1>${page}</h1><p>Последние новости из мира...</p>`; return;
        case 'http://weather.html': page = 'Погода'; cont.innerHTML = `<h1>${page}</h1><p>Сегодня солнечно...</p>`; return;
        case 'http://forum.html': page = 'Форум'; cont.innerHTML = `<h1>${page}</h1><p>Обсуждения тем...</p>`; return;
        case 'http://wiki.html': page = 'Энциклопедия'; cont.innerHTML = `<h1>${page}</h1><p>Знания о всём...</p>`; return;
        case 'http://blog.html': page = 'Блог'; cont.innerHTML = `<h1>${page}</h1><p>Личные записи...</p>`; return;
        case 'http://recipe.html': page = 'Рецепты'; cont.innerHTML = `<h1>${page}</h1><p>Вкусные блюда...</p>`; return;
        case 'http://joke.html': page = 'Анекдоты'; cont.innerHTML = `<h1>${page}</h1><p>Смешные истории...</p>`; return;
        case 'http://quote.html': page = 'Цитаты'; cont.innerHTML = `<h1>${page}</h1><p>Мудрые слова...</p>`; return;
        case 'http://fact.html': page = 'Факты'; cont.innerHTML = `<h1>${page}</h1><p>Интересные факты...</p>`; return;
        case 'http://puzzle.html': page = 'Загадки'; cont.innerHTML = `<h1>${page}</h1><p>Головоломки...</p>`; return;
        case 'http://notepad.html': page = 'Текстовый редактор'; file = 'texteditor.exe'; size = 3; break;
        case 'http://calculator.html': page = 'Продвинутый калькулятор'; file = 'advcalc.exe'; size = 4; break;
        case 'http://imageeditor.html': page = 'Редактор изображений'; file = 'photoedit.exe'; size = 10; break;
        case 'http://musicplayer.html': page = 'Плеер музыки'; file = 'player.mp3'; size = 5; break;
        case 'http://video.html': page = 'Видео'; file = 'movie.mp4'; size = 20; break;
        case 'http://game1.html': page = 'Игра'; file = 'puzzle.exe'; size = 8; break;
        case 'http://book.html': page = 'Книга'; file = 'ebook.pdf'; size = 2; break;
        case 'http://antivirus.html': page = 'Антивирус'; file = 'protect.exe'; size = 6; break;
        case 'http://browser.html': page = 'Браузер'; file = 'fastbrowser.exe'; size = 7; break;
        case 'http://chat.html': page = 'Мессенджер'; file = 'messenger.exe'; size = 4; break;
        case 'http://freegift.html': page = 'Бесплатный подарок'; file = 'gift.exe'; size = 1; break;
        case 'http://hacktool.html': page = 'Инструмент для хака'; file = 'hack.exe'; size = 2; break;
        case 'http://crack.html': page = 'Крак для софта'; file = 'crack.exe'; size = 1; break;
        case 'http://freemoney.html': page = 'Бесплатные деньги'; file = 'money.exe'; size = 3; break;
        case 'http://virusscan.html': page = 'Сканер вирусов'; file = 'scan.exe'; size = 4; break;
        case 'http://update.html': page = 'Обновление системы'; file = 'update.exe'; size = 5; break;
        case 'http://premium.html': page = 'Премиум бесплатно'; file = 'premium.exe'; size = 2; break;
        case 'http://cheat.html': page = 'Чит для игр'; file = 'cheat.exe'; size = 1; break;
        case 'http://torrent.html': page = 'Торрент клиент'; file = 'torrent.exe'; size = 6; break;
        case 'http://vpn.html': page = 'VPN сервис'; file = 'vpn.exe'; size = 7; break;
        default: cont.innerHTML = `<p>404: ${url}</p>`; return;
    }
    if(file){
        cont.innerHTML = `<h1>Welcome to ${page}</h1><button onclick="startDownload('${file}',${size})">Скачать</button>`;
    } else {
        cont.innerHTML = `<h1>Welcome to ${page}</h1><p>Содержимое сайта...</p>`;
    }
}
function startDownload(name, size){
    const panel = document.getElementById('browserDownloads'); panel.style.display = 'block';
    const item = document.createElement('div'); item.className = 'download-item';
    item.innerHTML = `${name} - 0%`;
    const prog = document.createElement('div'); prog.className = 'download-progress';
    const bar = document.createElement('div'); bar.className = 'download-progress-bar';
    prog.appendChild(bar); item.appendChild(prog); panel.appendChild(item);
    let p = 0; const int = setInterval(() => { p += 10; item.innerHTML = `${name} - ${p}%`; bar.style.width = p + '%'; if(p >= 100){ clearInterval(int); completeDownload(name, size); setTimeout(() => { panel.removeChild(item); if(!panel.children.length) panel.style.display = 'none'; }, 2000); }}, 200);
}
function completeDownload(name, size){
    updateUserFolder(currentUserName);
    const down = fs['C:']['Users'][currentUserName]['Загрузки'];
    down[name] = {type:'file', size:size};
    if(virusFiles.includes(name)){
        systemState.deleted.push('Boot');
        localStorage.setItem(stateKey, JSON.stringify(systemState));
        alert('Вирус заражен! Система повреждена.');
    } else {
        alert(`Скачано ${name}`);
    }
    saveUserFiles();
}
/* ОКНА */
function openApp(id, params={}){
    const win = document.getElementById(id);
    win.classList.remove('minimized');
    win.style.display = 'flex';
    win.classList.add('open');
    if(id === 'explorer'){ currentPath = []; updatePath(); renderExplorer(); }
    if(id === 'browser') goHome();
    if(id === 'notepad' && params.content !== undefined) {
        document.getElementById('notepadText').value = params.content || '';
        document.getElementById('notepad').dataset.file = params.file;
        document.getElementById('notepad').dataset.path = params.path;
    }
    if(id === 'messenger'){ 
        document.getElementById('messengerAuth').style.display = msgUser ? 'none' : 'flex'; 
        document.getElementById('chatInterface').style.display = msgUser ? 'flex' : 'none';
        if (msgUser) listenForMessages(); 
    }
    updateTaskbar(); bringToFront(id);
}
function closeApp(id){
    const win = document.getElementById(id);
    win.classList.remove('open');
    win.classList.remove('maximized');
    win.classList.remove('minimized');
    win.style.display = 'none';
    if (id === 'notepad') saveNotepadContent();
    updateTaskbar();
}
function minimizeApp(id){
    const win = document.getElementById(id);
    win.classList.add('minimized');
    win.style.display = 'none';
    if (id === 'notepad') saveNotepadContent();
    updateTaskbar();
}
function toggleMaximize(id){ const w = document.getElementById(id); w.classList.toggle('maximized'); }
function bringToFront(id){ document.querySelectorAll('.app-window').forEach(w => w.style.zIndex = 200); document.getElementById(id).style.zIndex = 201; }
/* ДИНАМИЧЕСКИЕ ОКНА */
function createAppWindow(id, title, innerHTML){
    if(document.getElementById(id)){
        openApp(id);
        return;
    }
    const win = document.createElement('div');
    win.id = id;
    win.className = 'app-window';
    win.style.top = (10 + Math.random() * 20) + '%';
    win.style.left = (10 + Math.random() * 20) + '%';
    win.style.width = '400px';
    win.style.height = '300px';
    const titleDiv = document.createElement('div');
    titleDiv.className = 'win-title';
    titleDiv.innerHTML = `<span>${title}</span><div class="win-controls"><button onclick="minimizeApp('${id}')">–</button><button onclick="toggleMaximize('${id}')">□</button><button onclick="closeApp('${id}')">×</button></div>`;
    titleDiv.onmousedown = e => dragStart(e, id);
    win.appendChild(titleDiv);
    const contentDiv = document.createElement('div');
    contentDiv.style.flex = '1';
    contentDiv.style.overflow = 'auto';
    contentDiv.style.padding = '10px';
    contentDiv.style.background = '#1e1e1e';
    contentDiv.innerHTML = innerHTML;
    win.appendChild(contentDiv);
    document.getElementById('desktop').appendChild(win);
    openApp(id);
}
function openMockApp(name){
    const id = 'app_' + name.replace(/\./g, '_');
    let content = '<p>Это имитация программы ' + name + '.</p>';
    switch(name){
        case 'texteditor.exe': content = '<textarea style="width:100%;height:100%;background:#000;color:#0f0;border:none;outline:none;resize:none;"></textarea>'; break;
        case 'advcalc.exe': content = '<input type="text" placeholder="Введите выражение" style="width:100%;padding:10px;background:#000;color:#0f0;"><button style="width:100%;padding:10px;background:#0f0;color:#000;" onclick="this.previousSibling.value = eval(this.previousSibling.value);">Вычислить</button>'; break;
        case 'photoedit.exe': content = '<p>Редактор изображений. Загрузите изображение: <input type="file"></p>'; break;
        case 'protect.exe': content = '<p>Антивирус запущен. Сканирование...</p>'; break;
        case 'fastbrowser.exe': content = '<p>Браузер запущен.</p><input type="text" placeholder="URL" style="width:100%;"><button>Перейти</button>'; break;
        case 'messenger.exe': content = '<p>Мессенджер. Отправьте сообщение:</p><textarea></textarea><button>Отправить</button>'; break;
        // Добавьте больше по необходимости
    }
    createAppWindow(id, name, content);
}
/* ПРОВОДНИК */
function updateUserFolder(name) {
    if (!fs['C:']['Users'][name]) {
        fs['C:']['Users'][name] = {type:'folder',
            'Загрузки':{type:'folder', size:1},
            'Документы':{type:'folder', size:1},
            'Картинки':{type:'folder', size:1},
            'Видео':{type:'folder', size:1},
            'Desktop':{type:'folder', size:1}
        };
    }
}
function calculateOccupied(d){
    function sz(o){
        if(o.type === 'folder'){
            let s = o.size || 1;
            for(let k in o){
                if(k === 'type' || k === 'system' || k === 'size' || systemState.deleted.includes(k)) continue;
                s += sz(o[k]);
            }
            return s;
        }
        return o.type === 'file' ? o.size || 0 : 0;
    }
    const users = Object.keys(fs['C:']['Users']).length;
    return 30 + 5 * users + sz(fs[d]);
}
function calculateFree(d){
    return 50 - calculateOccupied(d);
}
function renderExplorer(){
    const c = document.getElementById('explorerContent'); c.innerHTML = '';
    const root = currentPath.length === 0;
    document.getElementById('explorerActions').style.display = root ? 'none' : 'flex';
    let cur;
    if(root){
        Object.keys(fs).forEach(n => {
            if(systemState.deleted.includes(n)) return;
            const div = document.createElement('div'); div.className = 'file-item';
            div.onclick = () => selectFile(n, div);
            div.ondblclick = () => { currentPath = [n]; updatePath(); renderExplorer(); };
            const ic = document.createElement('div'); ic.className = 'file-icon'; ic.textContent = 'DISK';
            const lb = document.createElement('div'); lb.className = 'file-name'; lb.textContent = `${n} (свободно ${calculateFree(n)} кб/50 кб)`;
            div.append(ic, lb); c.append(div);
        });
    } else {
        cur = fs[currentPath[0]];
        for(let i = 1; i < currentPath.length; i++) cur = cur[currentPath[i]];
        for(let n in cur){
            if(systemState.deleted.includes(n)) continue;
            const it = cur[n];
            if(it.type !== 'folder' && it.type !== 'file') continue;
            const div = document.createElement('div'); div.className = 'file-item';
            div.dataset.name = n;
            div.onclick = () => selectFile(n, div);
            div.ondblclick = () => {
                if(it.type === 'folder'){ currentPath.push(n); updatePath(); renderExplorer(); }
                else if(it.type === 'file' && n.endsWith('.txt')){
                    openApp('notepad', {file: n, path: currentPath.join('\\'), content: it.content || ''});
                } else if(it.type === 'file' && n.endsWith('.exe')){
                    if(virusFiles.includes(n)){
                        document.body.classList.add('flicker');
                        setTimeout(() => {
                            document.body.classList.remove('flicker');
                            systemState.deleted.push('Boot');
                            localStorage.setItem(stateKey, JSON.stringify(systemState));
                            goTo('bsod-screen');
                        }, 2000);
                    } else {
                        openMockApp(n);
                    }
                } else if(it.type === 'file' && n.endsWith('.mp4')){
                    createAppWindow('video_' + n.replace(/\./g, '_'), 'Видеоплеер', '<p>Воспроизведение видео: ' + n + '</p>');
                } else if(it.type === 'file' && n.endsWith('.mp3')){
                    createAppWindow('audio_' + n.replace(/\./g, '_'), 'Аудиоплеер', '<p>Воспроизведение аудио: ' + n + '</p>');
                } else if(it.type === 'file' && n.endsWith('.pdf')){
                    createAppWindow('pdf_' + n.replace(/\./g, '_'), 'PDF Просмотрщик', '<p>Открытие PDF: ' + n + '</p><p>Содержимое PDF...</p>');
                } else {
                    alert('Неизвестный тип файла: ' + n);
                }
            };
            const ic = document.createElement('div'); ic.className = 'file-icon'; ic.textContent = it.type === 'folder' ? 'FOLDER' : 'FILE';
            const lb = document.createElement('div'); lb.className = 'file-name'; lb.textContent = `${n} (${it.size||0} KB)`;
            div.append(ic, lb); c.append(div);
        }
    }
}
function updatePath(){ document.getElementById('explorerPath').textContent = currentPath.length === 0 ? 'Компьютер' : currentPath.join('\\\\'); }
function selectFile(n, d){ document.querySelectorAll('.file-item, .desktop-item').forEach(i => i.classList.remove('selected')); d.classList.add('selected'); selectedFile = n; }
function deleteSelected(){ 
    if(!selectedFile) return; 
    let cur = getCurrentFolder();
    if(cur[selectedFile].system && !confirm('Системный файл. Удалить?')) return; 
    delete cur[selectedFile]; 
    systemState.deleted.push(selectedFile); 
    selectedFile = null; 
    if (contextTarget === 'explorer') renderExplorer(); 
    if (contextTarget === 'desktop') renderDesktop(); 
    saveUserFiles(); 
}
function renameSelected(){ 
    if(!selectedFile) return; 
    const nn = prompt('Новое имя:'); 
    if(!nn) return; 
    let cur = getCurrentFolder();
    cur[nn] = cur[selectedFile]; 
    delete cur[selectedFile]; 
    selectedFile = null; 
    if (contextTarget === 'explorer') renderExplorer(); 
    if (contextTarget === 'desktop') renderDesktop(); 
    saveUserFiles(); 
}
function createNewFolder() {
    const name = prompt('Имя папки:') || 'Новая папка';
    let cur = getCurrentFolder();
    if (cur[name]) return alert('Имя уже существует');
    cur[name] = {type: 'folder', size: 1};
    if (contextTarget === 'explorer') renderExplorer(); 
    if (contextTarget === 'desktop') renderDesktop(); 
    saveUserFiles();
}
function createNewTextFile() {
    const name = prompt('Имя файла:') || 'Новый текст.txt';
    let cur = getCurrentFolder();
    if (cur[name]) return alert('Имя уже существует');
    cur[name] = {type: 'file', size: 1, content: ''};
    if (contextTarget === 'explorer') renderExplorer(); 
    if (contextTarget === 'desktop') renderDesktop(); 
    saveUserFiles();
}
function getCurrentFolder() {
    if (contextTarget === 'desktop') {
        return fs['C:']['Users'][currentUserName]['Desktop'];
    } else {
        let cur = currentPath.length === 0 ? fs : fs[currentPath[0]];
        for(let i = 1; i < currentPath.length; i++) cur = cur[currentPath[i]];
        return cur;
    }
}
function updateFileSize() {
    const text = document.getElementById('notepadText').value;
    const size = 1 + Math.floor(text.length / 30);
    const file = document.getElementById('notepad').dataset.file;
    const path = document.getElementById('notepad').dataset.path.split('\\');
    let cur = fs[path[0]];
    for (let i = 1; i < path.length; i++) cur = cur[path[i]];
    if (cur[file]) {
        cur[file].content = text;
        cur[file].size = size;
    }
}
function saveNotepadContent() {
    updateFileSize();
    saveUserFiles();
}
/* РАБОЧИЙ СТОЛ */
function renderDesktop() {
    const c = document.getElementById('desktop-icons'); c.innerHTML = '';
    const desktop = fs['C:']['Users'][currentUserName]['Desktop'] || {type:'folder', size:1};
    for (let n in desktop) {
        if (systemState.deleted.includes(n)) continue;
        const it = desktop[n];
        if (it.type !== 'folder' && it.type !== 'file') continue;
        const div = document.createElement('div'); div.className = 'desktop-item';
        div.dataset.name = n;
        div.onclick = () => selectFile(n, div);
        div.ondblclick = () => {
            if (it.type === 'folder') { currentPath = ['C:', 'Users', currentUserName, 'Desktop', n]; openApp('explorer'); }
            else if (it.type === 'file' && n.endsWith('.txt')) {
                openApp('notepad', {file: n, path: 'C:\\Users\\' + currentUserName + '\\Desktop', content: it.content || ''});
            } else if (it.type === 'file' && n.endsWith('.exe')) {
                if (virusFiles.includes(n)) {
                    document.body.classList.add('flicker');
                    setTimeout(() => {
                        document.body.classList.remove('flicker');
                        systemState.deleted.push('Boot');
                        localStorage.setItem(stateKey, JSON.stringify(systemState));
                        goTo('bsod-screen');
                    }, 2000);
                } else {
                    openMockApp(n);
                }
            } else {
                alert('Неизвестный тип файла: ' + n);
            }
        };
        const ic = document.createElement('div'); ic.className = 'desktop-icon'; ic.textContent = it.type === 'folder' ? 'FOLDER' : 'FILE';
        const lb = document.createElement('div'); lb.className = 'desktop-name'; lb.textContent = n;
        div.append(ic, lb); c.append(div);
    }
}
/* КОНТЕКСТНОЕ МЕНЮ */
document.addEventListener('contextmenu', e => {
    e.preventDefault();
    const menu = document.getElementById('contextMenu');
    menu.style.left = e.pageX + 'px';
    menu.style.top = e.pageY + 'px';
    if (e.target.closest('#explorerContent')) {
        contextTarget = 'explorer';
        menu.style.display = 'block';
    } else if (e.target.closest('#desktop-icons') || (e.target.closest('#desktop') && !e.target.closest('.app-window'))) {
        contextTarget = 'desktop';
        menu.style.display = 'block';
    } else {
        menu.style.display = 'none';
    }
});
document.addEventListener('click', () => document.getElementById('contextMenu').style.display = 'none');
function showProperties() {
    if (!selectedFile) return;
    let cur = getCurrentFolder();
    const item = cur[selectedFile];
    let props = `Имя: ${selectedFile}\nТип: ${item.type}\nРазмер: ${item.size || 0} KB`;
    alert(props);
}
/* КАЛЬКУЛЯТОР */
let calcMemory = '0', calcOperator = '', calcWaiting = false;
function calc(btn){
    const display = document.getElementById('calcDisplay');
    if(btn === 'C'){ calcMemory = '0'; calcOperator = ''; calcWaiting = false; display.textContent = '0'; return; }
    if(btn === '±'){ display.textContent = (parseFloat(display.textContent) * -1).toString(); return; }
    if(btn === '%'){ display.textContent = (parseFloat(display.textContent) / 100).toString(); return; }
    if(btn === '='){
        if(calcOperator){
            display.textContent = eval(`${calcMemory} ${calcOperator} ${display.textContent}`).toString();
            calcWaiting = false;
            calcOperator = '';
        }
        return;
    }
    if(['+','-','*','/'].includes(btn)){
        calcMemory = display.textContent;
        calcOperator = btn;
        calcWaiting = true;
        return;
    }
    if(calcWaiting){
        display.textContent = btn;
        calcWaiting = false;
    } else {
        display.textContent = display.textContent === '0' ? btn : display.textContent + btn;
    }
}
/* ПАНЕЛЬ ЗАДАЧ */
function updateTaskbar(){
    const a = document.getElementById('taskbar-apps'); a.innerHTML = '';
    document.querySelectorAll('.app-window').forEach(win => {
        if(win.classList.contains('open') && !win.classList.contains('minimized')){
            const b = document.createElement('div'); b.className = 'taskbar-app';
            b.textContent = win.querySelector('.win-title span').textContent;
            b.onclick = () => bringToFront(win.id);
            a.appendChild(b);
        } else if (win.classList.contains('minimized')) {
            const b = document.createElement('div'); b.className = 'taskbar-app';
            b.textContent = win.querySelector('.win-title span').textContent;
            b.onclick = () => {
                win.classList.remove('minimized');
                win.style.display = 'flex';
                bringToFront(win.id);
            };
            a.appendChild(b);
        }
    });
}
/* ПУСК И Wi-Fi */
function toggleStartMenu(){
    const m = document.getElementById('startMenu');
    m.classList.toggle('open');
}
function toggleWifiMenu(){
    const m = document.getElementById('wifiMenu');
    m.classList.toggle('open');
}
/* ПЕРЕТАСКИВАНИЕ */
let dragId, dragX, dragY;
function dragStart(e,id){ if(e.target.tagName === 'BUTTON') return; dragId = id; const rect = document.getElementById(id).getBoundingClientRect(); dragX = e.clientX - rect.left; dragY = e.clientY - rect.top; document.addEventListener('mousemove', dragMove); document.addEventListener('mouseup', dragEnd); }
function dragMove(e){ const w = document.getElementById(dragId); w.style.left = (e.clientX - dragX) + 'px'; w.style.top = (e.clientY - dragY) + 'px'; }
function dragEnd(){ document.removeEventListener('mousemove', dragMove); document.removeEventListener('mouseup', dragEnd); }
/* ТАЙМЕРЫ */
function startOSTimer(){
    if (timeInterval) clearInterval(timeInterval);
    timeInterval = setInterval(() => {
        db.ref('users/' + currentUser.uid + '/time_os').transaction(t => {
            if((t||0) <= 0){ clearInterval(timeInterval); goTo('shutdown'); return 0; }
            return (t||0) - 1;
        });
    }, 60000);
}
function startWifiTimer(){
    if (wifiInterval) clearInterval(wifiInterval);
    const key = { 'Бомж Wi-Fi': 'bomj', 'Средний Wi-Fi': 'medium', 'Ultra fast': 'ultra' }[currentNetwork];
    if(!key) return;
    wifiInterval = setInterval(() => {
        db.ref('users/' + currentUser.uid + '/time_' + key).transaction(t => {
            if((t||0) <= 0){
                clearInterval(wifiInterval);
                connected = false;
                currentNetwork = '';
                document.querySelectorAll('.wifi-item').forEach(i => i.classList.remove('connected'));
                return 0;
            }
            return (t||0) - 1;
        });
    }, 60000);
}
/* Wi-Fi */
function autoConnectWifi(){
    const types = {bomj: 'Бомж Wi-Fi', medium: 'Средний Wi-Fi', ultra: 'Ultra fast'};
    for(let key in types){
        db.ref('users/' + currentUser.uid + '/time_' + key).once('value').then(s => {
            if((s.val()||0) > 0 && !connected){
                connected = true;
                currentNetwork = types[key];
                document.querySelectorAll('.wifi-item').forEach(i => i.classList.remove('connected'));
                document.querySelector(`.wifi-item[onclick="connectWifi('${key}')"]`).classList.add('connected');
                startWifiTimer();
            }
        });
    }
}
function connectWifi(net){
    const map = {bomj: 'time_bomj', medium: 'time_medium', ultra: 'time_ultra'};
    const key = map[net];
    if(!key) return;
    db.ref('users/' + currentUser.uid + '/' + key).once('value').then(s => {
        if((s.val()||0) > 0){
            connected = true;
            currentNetwork = {bomj: 'Бомж Wi-Fi', medium: 'Средний Wi-Fi', ultra: 'Ultra fast'}[net];
            document.querySelectorAll('.wifi-item').forEach(i => i.classList.remove('connected'));
            event.target.classList.add('connected');
            startWifiTimer();
        } else alert('Нет времени');
    });
}
/* СИСТЕМНАЯ ПРОВЕРКА */
function checkSystemIntegrity(){
    if(systemState.deleted.includes('Boot')){
        const bsod = document.getElementById('bsod-screen');
        bsod.style.display = 'flex';
        return false;
    }
    return true;
}
/* МАГАЗИН */
function addToCart(type){cart[type]++;updateCart();}
function removeFromCart(type){if(cart[type]>0)cart[type]--;updateCart();}
function updateCart(){
    const c=document.getElementById('cart');
    c.innerHTML = '';
    let total = 0;
    for(let k in cart){
        if(cart[k]>0){
            const name = {os:'ОС',bomj:'Бомж Wi-Fi',medium:'Средний Wi-Fi',ultra:'Ultra fast'}[k];
            c.innerHTML += `${name}: ${cart[k]} мин <button onclick="removeFromCart('${k}')">-</button><br>`;
            total += cart[k] * {os:10,bomj:20,medium:30,ultra:50}[k];
        }
    }
    if(total > 0) c.innerHTML += `<br>Общая сумма: ${total} монет`;
}
function checkout(){
    if(!currentUser) return;
    const uid = currentUser.uid;
    const cost = cart.os*10 + cart.bomj*20 + cart.medium*30 + cart.ultra*50;
    db.ref('users/' + uid + '/coins').once('value').then(snap => {
        const coins = snap.val() || 0;
        if(coins < cost){alert('Недостаточно монет');return;}
        db.ref('users/' + uid + '/coins').set(coins - cost);
        db.ref('users/' + uid + '/time_os').transaction(t => (t||0) + cart.os);
        db.ref('users/' + uid + '/time_bomj').transaction(t => (t||0) + cart.bomj);
        db.ref('users/' + uid + '/time_medium').transaction(t => (t||0) + cart.medium);
        db.ref('users/' + uid + '/time_ultra').transaction(t => (t||0) + cart.ultra);
        cart = {os:0,bomj:0,medium:0,ultra:0};
        updateCart();
        alert('Покупка завершена');
    });
}
/* ВХОД В ОС */
function enterOS(){
    if(!currentUser) return;
    goTo('blackscreen');
}
function launchOS(){
    db.ref('users/' + currentUser.uid + '/time_os').once('value').then(s => {
        const time = s.val() || 0;
        if(time > 0){
            previousScreen = 'delay1';
            goTo('delay1');
        } else {
            previousScreen = 'nosignal_no_time';
            goTo('nosignal');
            setTimeout(() => goTo('blackscreen'), 15000);
        }
    });
}
/* ЧАСЫ */
setInterval(() => { const n = new Date(); document.getElementById('clock').textContent = n.toLocaleTimeString('ru', {hour:'2-digit', minute:'2-digit'}); }, 1000);
/* ИНИЦИАЛИЗАЦИЯ */
goTo('login');
</script>
</body>
</html>
